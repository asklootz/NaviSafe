<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NaviSafe - Aviation Obstacle Reporting</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        :root {
            --background: #ffffff;
            --foreground: #1a1a1a;
            --card: #ffffff;
            --card-foreground: #1a1a1a;
            --primary: #030213;
            --primary-foreground: #ffffff;
            --secondary: #f3f3f5;
            --secondary-foreground: #030213;
            --muted: #ececf0;
            --muted-foreground: #717182;
            --accent: #e9ebef;
            --border: rgba(0, 0, 0, 0.1);
            --input: #f3f3f5;
            --ring: #cbd5e1;
            --radius: 0.625rem;
        }

        .dark {
            --background: #18181b;
            --foreground: #f4f4f5;
            --card: #27272a;
            --card-foreground: #f4f4f5;
            --primary: #f4f4f5;
            --primary-foreground: #18181b;
            --secondary: #3f3f46;
            --secondary-foreground: #f4f4f5;
            --muted: #3f3f46;
            --muted-foreground: #a1a1aa;
            --accent: #3f3f46;
            --border: #3f3f46;
            --input: #27272a;
            --ring: #52525b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .dark .btn-secondary {
            background-color: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }

        .dark .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }

        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .input, .textarea, .select {
            background-color: var(--input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            width: 100%;
            color: var(--foreground);
            font-size: 1rem;
        }

        .input:focus, .textarea:focus, .select:focus {
            outline: 2px solid var(--ring);
            outline-offset: 2px;
        }

        .input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .textarea {
            resize: vertical;
            min-height: 100px;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--card);
            border-radius: var(--radius);
            max-width: 56rem;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            width: 100%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-green {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }

        .dark .badge-green {
            background-color: #064e3b;
            color: #d1fae5;
        }

        .dark .badge-blue {
            background-color: #1e3a8a;
            color: #dbeafe;
        }

        .dark .badge-yellow {
            background-color: #78350f;
            color: #fef3c7;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }

        tr:hover {
            background-color: var(--accent);
        }

        .autocomplete-dropdown {
            position: absolute;
            z-index: 50;
            width: 100%;
            margin-top: 0.25rem;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-height: 15rem;
            overflow-y: auto;
        }

        .autocomplete-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
            background: transparent;
            border: none;
            color: var(--foreground);
            font-size: 1rem;
        }

        .autocomplete-item:hover {
            background-color: var(--accent);
        }

        /* SVG Icons as inline */
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-lg {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Leaflet override for dark mode */
        .dark .leaflet-container {
            background: #1f2937;
        }

        .dark .leaflet-popup-content-wrapper {
            background: #374151;
            color: #f9fafb;
        }

        .dark .leaflet-popup-tip {
            background: #374151;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #2563eb;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .card {
                padding: 1rem;
            }
            
            .modal-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>

<div id="app"></div>

<script>
// ============================================================================
// NAVISAFE - PURE JAVASCRIPT APPLICATION
// ============================================================================

// ============================================================================
// DATA MODELS
// ============================================================================

const mockUsers = [
    {
        id: '1',
        username: 'pilot1',
        email: 'pilot1@nla.no',
        role: 'pilot',
        organization: 'NLA',
        created_at: '2025-01-15T10:00:00Z',
    },
    {
        id: '2',
        username: 'pilot2',
        email: 'pilot2@luftforsvaret.no',
        role: 'pilot',
        organization: 'Luftforsvaret',
        created_at: '2025-01-16T10:00:00Z',
    },
    {
        id: '3',
        username: 'admin',
        email: 'admin@kartverket.no',
        role: 'admin',
        organization: 'Kartverket',
        created_at: '2025-01-10T10:00:00Z',
    },
    {
        id: '4',
        username: 'pilot3',
        email: 'pilot3@politiet.no',
        role: 'pilot',
        organization: 'Politiet',
        created_at: '2025-01-17T10:00:00Z',
    },
];

const mockObstacleReports = [
    {
        id: 'r1',
        reporter_id: '1',
        reporter_name: 'pilot1',
        organization: 'NLA',
        obstacle_type: 'Tower',
        geometry_type: 'Point',
        geometry: { type: 'Point', coordinates: [8.0182, 58.1599] },
        height_meters: 45,
        description: 'High tower near Kristiansand Airport',
        comments: 'Observed during landing',
        status: 'Submitted',
        created_at: '2025-10-28T14:30:00Z',
        updated_at: '2025-10-28T14:30:00Z',
        reporter_position: { type: 'Point', coordinates: [8.0165, 58.1585] },
        reporter_position_accuracy: 12,
    },
    {
        id: 'r2',
        reporter_id: '2',
        reporter_name: 'pilot2',
        organization: 'Luftforsvaret',
        obstacle_type: 'Power Line',
        geometry_type: 'LineString',
        geometry: {
            type: 'LineString',
            coordinates: [[10.7522, 59.9139], [10.7700, 59.9200]],
        },
        height_meters: 25,
        description: 'Power line over Oslo Fjord',
        comments: 'Difficult to see in poor weather',
        status: 'Submitted',
        created_at: '2025-10-27T10:15:00Z',
        updated_at: '2025-10-29T09:00:00Z',
    },
    {
        id: 'r3',
        reporter_id: '1',
        reporter_name: 'pilot1',
        organization: 'NLA',
        obstacle_type: 'Wind Turbine',
        geometry_type: 'Point',
        geometry: { type: 'Point', coordinates: [5.7331, 58.9700] },
        height_meters: 80,
        description: 'Wind turbine near Stavanger',
        status: 'Approved',
        created_at: '2025-10-25T16:45:00Z',
        updated_at: '2025-10-26T11:30:00Z',
    },
    {
        id: 'r4',
        reporter_id: '1',
        reporter_name: 'pilot1',
        organization: 'NLA',
        obstacle_type: 'Tower',
        geometry_type: 'Point',
        geometry: { type: 'Point', coordinates: [10.4041, 63.4368] },
        height_meters: 55,
        description: 'Communication tower',
        status: 'Draft',
        created_at: '2025-10-29T08:15:00Z',
        updated_at: '2025-10-29T08:15:00Z',
    },
];

// ============================================================================
// APPLICATION STATE
// ============================================================================

const AppState = {
    currentView: 'login',
    currentUser: null,
    theme: localStorage.getItem('navisafe_theme') || 'light',
    reports: JSON.parse(JSON.stringify(mockObstacleReports)),
    editingReport: null,
    currentPosition: null,
    gpsWatchId: null,
    map: null,
    drawLayer: null,
    geometryType: 'Point',
    currentGeometry: null,
    linePoints: [],
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function showToast(message, description = '', type = 'success') {
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(t => t.remove());
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    
    const icons = {
        success: '✓',
        error: '✗',
        info: 'ℹ',
    };
    
    const colors = {
        success: 'bg-green-50 dark:bg-green-900 text-green-900 dark:text-green-100 border-green-200',
        error: 'bg-red-50 dark:bg-red-900 text-red-900 dark:text-red-100 border-red-200',
        info: 'bg-blue-50 dark:bg-blue-900 text-blue-900 dark:text-blue-100 border-blue-200',
    };
    
    toast.innerHTML = `
        <div class="${colors[type]} p-4 rounded-lg border">
            <div class="flex items-start gap-3">
                <span style="font-size: 1.5rem;">${icons[type]}</span>
                <div>
                    <div style="font-weight: 600;">${message}</div>
                    ${description ? `<div style="font-size: 0.875rem; margin-top: 0.25rem; opacity: 0.9;">${description}</div>` : ''}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function toggleTheme() {
    AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('navisafe_theme', AppState.theme);
    applyTheme();
}

function applyTheme() {
    if (AppState.theme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
}

function mockLogin(username, password) {
    const user = mockUsers.find(u => u.username === username);
    return user && password.length > 0 ? user : null;
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = (lat1 * Math.PI) / 180;
    const φ2 = (lat2 * Math.PI) / 180;
    const Δφ = ((lat2 - lat1) * Math.PI) / 180;
    const Δλ = ((lon2 - lon1) * Math.PI) / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
        Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c;
}

function findPotentialDuplicates(report, allReports, radiusMeters = 100) {
    const duplicates = [];
    if (report.geometry.type !== 'Point') return duplicates;

    const [lon, lat] = report.geometry.coordinates;

    for (const otherReport of allReports) {
        if (otherReport.id === report.id || otherReport.status === 'Draft') continue;

        if (otherReport.geometry.type === 'Point') {
            const [otherLon, otherLat] = otherReport.geometry.coordinates;
            const distance = calculateDistance(lat, lon, otherLat, otherLon);

            if (distance <= radiusMeters && otherReport.obstacle_type === report.obstacle_type) {
                duplicates.push({ ...otherReport, distance });
            }
        }
    }

    return duplicates.sort((a, b) => a.distance - b.distance);
}

// ============================================================================
// GPS TRACKING
// ============================================================================

function startGPSTracking() {
    if (!navigator.geolocation) {
        AppState.currentPosition = { lat: 58.1467, lng: 7.9956, accuracy: 50 };
        return;
    }

    AppState.gpsWatchId = navigator.geolocation.watchPosition(
        (position) => {
            AppState.currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
            };
            updateGPSDisplay();
        },
        (error) => {
            AppState.currentPosition = { lat: 58.1467, lng: 7.9956, accuracy: 50 };
            updateGPSDisplay();
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
}

function stopGPSTracking() {
    if (AppState.gpsWatchId) {
        navigator.geolocation.clearWatch(AppState.gpsWatchId);
        AppState.gpsWatchId = null;
    }
}

function updateGPSDisplay() {
    const gpsEl = document.getElementById('gps-coords');
    if (gpsEl && AppState.currentPosition) {
        gpsEl.innerHTML = `${AppState.currentPosition.lat.toFixed(6)}°N, ${AppState.currentPosition.lng.toFixed(6)}°E <span style="font-size: 0.75rem; margin-left: 0.5rem;">(±${AppState.currentPosition.accuracy.toFixed(0)}m)</span>`;
    }
}

// ============================================================================
// SVG ICONS
// ============================================================================

const Icons = {
    moon: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>',
    sun: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
    logo: '<svg class="icon-lg" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>',
    plus: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>',
    list: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>',
    navigation: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>',
    camera: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
    send: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>',
    save: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>',
    mapPin: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
    minus: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14"></path></svg>',
    x: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
    eye: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>',
    check: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
    checkCircle: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
    alertTriangle: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
    radio: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg>',
    zap: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>',
    wind: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
    building: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>',
    help: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
};

function getObstacleIcon(type) {
    const icons = {
        'Tower': Icons.radio,
        'Power Line': Icons.zap,
        'Wind Turbine': Icons.wind,
        'Building': Icons.building,
        'Other': Icons.help,
    };
    return icons[type] || Icons.help;
}

// ============================================================================
// VIEW FUNCTIONS
// ============================================================================

function renderLoginScreen() {
    const savedUsername = localStorage.getItem('navisafe_remembered_username') || '';
    
    return `
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(to bottom right, #dbeafe, #bfdbfe); padding: 1rem;">
            <div class="dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800" style="position: absolute; inset: 0; z-index: -1;"></div>
            <div style="position: absolute; top: 1rem; right: 1rem;">
                <button onclick="toggleTheme()" class="btn btn-secondary" style="padding: 0.75rem; border-radius: 9999px;">
                    ${AppState.theme === 'light' ? Icons.moon : Icons.sun}
                </button>
            </div>
            <div class="card" style="width: 100%; max-width: 28rem;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="margin: 0 auto; width: 12rem; height: 12rem; display: flex; align-items: center; justify-content: center; color: #2563eb;">
                        <svg style="width: 100%; height: 100%;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <h1 style="font-size: 1.5rem; font-weight: 600; margin-top: 1rem;">Login</h1>
                    <p style="color: var(--muted-foreground); margin-top: 0.5rem;">Welcome to NaviSafe reporting system</p>
                </div>
                <form onsubmit="handleLogin(event)" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label for="username" style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Username</label>
                        <input id="username" type="text" class="input" placeholder="Enter username" value="${savedUsername}" required />
                    </div>
                    <div>
                        <label for="password" style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Password</label>
                        <input id="password" type="password" class="input" placeholder="Enter password" required />
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input id="remember" type="checkbox" ${savedUsername ? 'checked' : ''} style="width: 1rem; height: 1rem;" />
                        <label for="remember" style="font-size: 0.875rem; cursor: pointer;">Remember me</label>
                    </div>
                    <div id="login-error" class="hidden" style="color: #dc2626; font-size: 0.875rem;"></div>
                    <button type="submit" class="btn btn-primary" style="padding: 0.75rem;">
                        Login
                    </button>
                    <div style="font-size: 0.75rem; text-align: center; color: var(--muted-foreground); margin-top: 0.5rem;">
                        Demo users: pilot1, pilot2 (pilots) | admin (administrator)<br>Password: any
                    </div>
                </form>
            </div>
        </div>
    `;
}

function renderPilotDashboard() {
    const userReports = AppState.reports.filter(r => r.reporter_id === AppState.currentUser.id);
    
    return `
        <div style="min-height: 100vh; background: linear-gradient(to bottom right, #dbeafe, #bfdbfe); padding: 1rem;">
            <div class="dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800" style="position: absolute; inset: 0; z-index: -1;"></div>
            <div style="max-width: 72rem; margin: 0 auto;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="color: #2563eb;">
                            ${Icons.logo}
                        </div>
                        <div>
                            <h1 style="font-size: 1.25rem; font-weight: 600;">NaviSafe</h1>
                            <p style="font-size: 0.875rem; color: var(--muted-foreground);">${AppState.currentUser.username} (${AppState.currentUser.organization})</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="navigateTo('pilot-report')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                            ${Icons.plus}
                            <span style="margin-left: 0.5rem;">New Report</span>
                        </button>
                        <button onclick="toggleTheme()" class="btn btn-secondary" style="padding: 0.75rem; border-radius: 9999px;">
                            ${AppState.theme === 'light' ? Icons.moon : Icons.sun}
                        </button>
                        <button onclick="handleLogout()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                            Logout
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">My Reports</h2>
                    ${userReports.length === 0 ? `
                        <div style="text-align: center; padding: 3rem 0; color: var(--muted-foreground);">
                            <svg style="width: 4rem; height: 4rem; margin: 0 auto 1rem; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>No reports yet. Click "New Report" to create your first obstacle report.</p>
                        </div>
                    ` : `
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${userReports.map(report => `
                                        <tr>
                                            <td>${report.id}</td>
                                            <td>${report.obstacle_type}</td>
                                            <td>
                                                <span class="badge ${
                                                    report.status === 'Approved' ? 'badge-green' :
                                                    report.status === 'Submitted' ? 'badge-blue' :
                                                    'badge-yellow'
                                                }">
                                                    ${report.status}
                                                </span>
                                            </td>
                                            <td>${new Date(report.created_at).toLocaleDateString()}</td>
                                            <td>
                                                ${report.status === 'Draft' ? `
                                                    <button onclick="editReport('${report.id}')" class="btn btn-secondary btn-sm">
                                                        Edit
                                                    </button>
                                                ` : `
                                                    <button onclick="viewReport('${report.id}')" class="btn btn-secondary btn-sm">
                                                        ${Icons.eye}
                                                        <span style="margin-left: 0.25rem;">View</span>
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
}

function renderPilotReportForm() {
    const isEditing = !!AppState.editingReport;
    const report = AppState.editingReport || {};
    
    return `
        <div style="min-height: 100vh; background: linear-gradient(to bottom right, #dbeafe, #bfdbfe); padding: 1rem;">
            <div class="dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800" style="position: absolute; inset: 0; z-index: -1;"></div>
            <div style="max-width: 56rem; margin: 0 auto;">
                <div style="display: flex; align-items: center; justify-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="color: #2563eb;">${Icons.logo}</div>
                        <div>
                            <h1 style="font-size: 1.25rem; font-weight: 600;">NaviSafe</h1>
                            <p style="font-size: 0.875rem; color: var(--muted-foreground);">${isEditing ? 'Edit Report' : 'New Report'}</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="navigateTo('pilot-dashboard')" class="btn btn-secondary" style="display: none;">
                            ${Icons.list}
                            <span style="margin-left: 0.5rem;">My Reports</span>
                        </button>
                        <button onclick="toggleTheme()" class="btn btn-secondary" style="padding: 0.75rem; border-radius: 9999px;">
                            ${AppState.theme === 'light' ? Icons.moon : Icons.sun}
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Report Aviation Obstacle</h2>
                    <p style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 1.5rem;">Select obstacle type and mark position on map</p>
                    
                    <form onsubmit="handleSubmitReport(event)" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Obstacle Type *</label>
                            <div style="position: relative;">
                                <input 
                                    id="obstacle-type-input" 
                                    type="text" 
                                    class="input"
                                    style="height: 3.5rem; font-size: 1.125rem;"
                                    placeholder="Type to search or enter custom type..."
                                    value="${report.obstacle_type || ''}"
                                    onfocus="showObstacleTypeDropdown()"
                                    onblur="setTimeout(() => hideObstacleTypeDropdown(), 200)"
                                    oninput="filterObstacleTypes(this.value)"
                                    required
                                />
                                <div id="obstacle-type-dropdown" class="autocomplete-dropdown hidden"></div>
                            </div>
                        </div>

                        <div>
                            <label for="height" style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Height (feet) *</label>
                            <input 
                                id="height" 
                                type="number" 
                                class="input"
                                style="height: 4rem; font-size: 1.125rem;"
                                placeholder="e.g. 150"
                                value="${report.height_meters ? Math.round(report.height_meters * 3.28084) : ''}"
                                oninput="updateHeightMeters(this.value)"
                                required
                            />
                            <p id="height-meters" style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.5rem;"></p>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Mark Position on Map *</label>
                            <div style="position: relative; border: 4px solid #93c5fd; border-radius: 0.5rem; overflow: hidden;">
                                <div id="map" style="height: 450px; width: 100%;"></div>
                                
                                <div style="position: absolute; left: 0.75rem; bottom: 0.75rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <button type="button" id="btn-point" onclick="setGeometryType('Point')" 
                                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #2563eb; background: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                                        ${Icons.mapPin}
                                        <span style="font-size: 0.875rem;">Point</span>
                                    </button>
                                    <button type="button" id="btn-line" onclick="setGeometryType('LineString')"
                                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #d1d5db; background: white; color: #374151; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                                        ${Icons.minus}
                                        <span style="font-size: 0.875rem;">Line</span>
                                    </button>
                                    <button type="button" onclick="clearDrawing()"
                                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #d1d5db; background: white; color: #374151; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                                        ${Icons.x}
                                        <span style="font-size: 0.875rem;">Clear</span>
                                    </button>
                                </div>
                            </div>

                            <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 1rem; margin-top: 0.75rem;">
                                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                    <div style="color: #2563eb; flex-shrink: 0; margin-top: 0.125rem;">
                                        ${Icons.navigation}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                            <div>
                                                <span style="color: #1e3a8a; font-weight: 500;">Live GPS: </span>
                                                <span id="gps-coords" style="color: #1e40af; font-family: monospace; font-size: 0.875rem;">
                                                    ${AppState.currentPosition ? 
                                                        `${AppState.currentPosition.lat.toFixed(6)}°N, ${AppState.currentPosition.lng.toFixed(6)}°E (±${AppState.currentPosition.accuracy.toFixed(0)}m)` :
                                                        'Acquiring GPS signal...'
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                        <button type="button" id="use-gps-btn" onclick="useGPSPosition()" 
                                            class="btn btn-primary"
                                            style="width: 100%; height: 4rem; font-size: 1.125rem;">
                                            ${Icons.navigation}
                                            <span style="margin-left: 0.75rem;">Use My GPS Position</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="geometry-status" class="hidden" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.875rem; color: #059669;">
                                <div style="width: 0.75rem; height: 0.75rem; background: #10b981; border-radius: 9999px;"></div>
                                Position marked on map
                            </div>

                            <div id="manual-coords" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Or Enter Coordinates Manually</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                    <div>
                                        <label for="latitude" style="display: block; font-size: 0.875rem; margin-bottom: 0.5rem;">Latitude (Y) *</label>
                                        <input 
                                            id="latitude" 
                                            type="number" 
                                            step="0.000001" 
                                            class="input"
                                            style="height: 3rem;"
                                            placeholder="e.g. 58.146700"
                                            oninput="updateManualCoordinates()"
                                        />
                                        <p style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem;">Range: -90 to 90</p>
                                    </div>
                                    <div>
                                        <label for="longitude" style="display: block; font-size: 0.875rem; margin-bottom: 0.5rem;">Longitude (X) *</label>
                                        <input 
                                            id="longitude" 
                                            type="number" 
                                            step="0.000001" 
                                            class="input"
                                            style="height: 3rem;"
                                            placeholder="e.g. 7.995600"
                                            oninput="updateManualCoordinates()"
                                        />
                                        <p style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem;">Range: -180 to 180</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Photo (optional)</label>
                            <input 
                                id="photo-input" 
                                type="file" 
                                accept="image/*" 
                                capture="environment"
                                onchange="handlePhotoUpload(event)"
                                class="hidden"
                            />
                            <button type="button" onclick="document.getElementById('photo-input').click()" 
                                class="btn btn-secondary"
                                style="width: 100%; height: 4rem;">
                                ${Icons.camera}
                                <span id="photo-label" style="margin-left: 0.75rem;">Take or Upload Photo</span>
                            </button>
                        </div>

                        <div>
                            <label for="description" style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Description (optional)</label>
                            <textarea 
                                id="description" 
                                class="textarea"
                                style="font-size: 1.125rem;"
                                rows="4"
                                placeholder="Describe the obstacle..."
                            >${report.description || ''}</textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding-top: 1rem;">
                            <button type="submit" class="btn btn-primary" style="height: 5rem; font-size: 1.125rem;">
                                ${Icons.send}
                                <span style="margin-left: 0.75rem;">Send Report to NRL</span>
                            </button>
                            <button type="button" onclick="handleSubmitReport(event, true)" class="btn btn-secondary" style="height: 5rem; font-size: 1.125rem;">
                                ${Icons.save}
                                <span style="margin-left: 0.75rem;">Save as Draft</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
}

function renderAdminDashboard() {
    const reports = AppState.reports.filter(r => r.status !== 'Draft');
    
    return `
        <div style="min-height: 100vh; background: linear-gradient(to bottom right, #dbeafe, #bfdbfe);">
            <div class="dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800" style="position: absolute; inset: 0; z-index: -1;"></div>
            
            <div style="position: sticky; top: 0; z-index: 10; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); padding: 1rem;">
                <div style="max-width: 80rem; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="color: #2563eb;">${Icons.logo}</div>
                        <div>
                            <h1 style="font-size: 1.25rem; font-weight: 600;">Submitted Reports to NRL</h1>
                            <p style="font-size: 0.875rem; color: var(--muted-foreground);">${AppState.currentUser.username} (Admin)</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="toggleTheme()" class="btn btn-secondary" style="padding: 0.75rem; border-radius: 9999px;">
                            ${AppState.theme === 'light' ? Icons.moon : Icons.sun}
                        </button>
                        <button onclick="handleLogout()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <div style="padding: 1rem; max-width: 80rem; margin: 0 auto;">
                <div class="card">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Reports Management</h2>
                    <p style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 1.5rem;">View and manage reports from pilots and flight crew</p>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="admin-sort" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Sort by</label>
                            <select id="admin-sort" onchange="updateAdminView()" class="select">
                                <option value="date-newest">Newest first</option>
                                <option value="date-oldest">Oldest first</option>
                                <option value="duplicates-most">Most duplicates</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="admin-status" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Status</label>
                            <select id="admin-status" onchange="updateAdminView()" class="select">
                                <option value="all">All</option>
                                <option value="Submitted" selected>Submitted</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                    </div>

                    <div id="reports-list">
                        ${renderAdminReportsTable(reports)}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderAdminReportsTable(reports) {
    if (reports.length === 0) {
        return `
            <div style="text-align: center; padding: 3rem 0; color: var(--muted-foreground);">
                <p>No reports found</p>
            </div>
        `;
    }

    return `
        <div style="border: 1px solid var(--border); border-radius: 0.5rem; overflow: hidden;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Organization</th>
                        <th>Reporter</th>
                        <th>Status</th>
                        <th>Duplicates</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${reports.map(report => {
                        const duplicates = findPotentialDuplicates(report, AppState.reports);
                        return `
                            <tr>
                                <td>${report.id}</td>
                                <td>${report.obstacle_type}</td>
                                <td>${report.organization}</td>
                                <td>${report.reporter_name}</td>
                                <td>
                                    <span class="badge ${
                                        report.status === 'Approved' ? 'badge-green' :
                                        report.status === 'Submitted' ? 'badge-blue' :
                                        'badge-yellow'
                                    }">
                                        ${report.status}
                                    </span>
                                </td>
                                <td>
                                    ${duplicates.length > 0 ? `
                                        <span class="badge badge-yellow">
                                            ⚠ ${duplicates.length}
                                        </span>
                                    ` : `<span style="color: var(--muted-foreground);">-</span>`}
                                </td>
                                <td>${new Date(report.created_at).toLocaleDateString()}</td>
                                <td>
                                    <button onclick="viewAdminReport('${report.id}')" class="btn btn-secondary btn-sm">
                                        ${Icons.eye}
                                        <span style="margin-left: 0.25rem;">View</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ============================================================================
// MAP FUNCTIONS
// ============================================================================

function initMap() {
    if (AppState.map) {
        AppState.map.remove();
    }

    const mapEl = document.getElementById('map');
    if (!mapEl) return;

    const centerLat = AppState.currentPosition ? AppState.currentPosition.lat : 58.1467;
    const centerLng = AppState.currentPosition ? AppState.currentPosition.lng : 7.9956;

    AppState.map = L.map('map').setView([centerLat, centerLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19,
    }).addTo(AppState.map);

    AppState.drawLayer = L.layerGroup().addTo(AppState.map);

    AppState.map.on('click', function(e) {
        if (AppState.geometryType === 'Point') {
            AppState.drawLayer.clearLayers();
            AppState.linePoints = [];

            const markerIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iNDEiIHZpZXdCb3g9IjAgMCAyNSA0MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi43IDAuNyAzLjlsMTEuOCAyNC42IDExLjgtMjQuNmMwLjQtMS4yIDAuNy0yLjYgMC43LTMuOUMyNSA1LjYgMTkuNCAwIDEyLjUgMHptMCAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjUtMiA0LjUtNC41IDQuNXoiIGZpbGw9IiMzMzg4ZmYiLz48L3N2Zz4=',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
            });

            L.marker(e.latlng, { icon: markerIcon }).addTo(AppState.drawLayer);

            AppState.currentGeometry = {
                type: 'Point',
                coordinates: [e.latlng.lng, e.latlng.lat],
            };

            document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
            document.getElementById('longitude').value = e.latlng.lng.toFixed(6);

            showGeometryStatus();
        } else if (AppState.geometryType === 'LineString') {
            AppState.linePoints.push(e.latlng);

            AppState.drawLayer.clearLayers();

            AppState.linePoints.forEach(point => {
                L.circleMarker(point, { radius: 5, color: 'red' }).addTo(AppState.drawLayer);
            });

            if (AppState.linePoints.length >= 2) {
                L.polyline(AppState.linePoints, { color: 'red', weight: 3 }).addTo(AppState.drawLayer);

                AppState.currentGeometry = {
                    type: 'LineString',
                    coordinates: AppState.linePoints.map(p => [p.lng, p.lat]),
                };

                showGeometryStatus();
            }
        }
    });
}

function setGeometryType(type) {
    AppState.geometryType = type;
    
    const btnPoint = document.getElementById('btn-point');
    const btnLine = document.getElementById('btn-line');
    const manualCoords = document.getElementById('manual-coords');
    const useGpsBtn = document.getElementById('use-gps-btn');
    
    if (type === 'Point') {
        btnPoint.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #2563eb; background: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);';
        btnLine.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #d1d5db; background: white; color: #374151; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);';
        if (manualCoords) manualCoords.style.display = 'block';
        if (useGpsBtn) useGpsBtn.style.display = 'flex';
    } else {
        btnPoint.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #d1d5db; background: white; color: #374151; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);';
        btnLine.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #2563eb; background: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);';
        if (manualCoords) manualCoords.style.display = 'none';
        if (useGpsBtn) useGpsBtn.style.display = 'none';
    }
    
    clearDrawing();
}

function clearDrawing() {
    if (AppState.drawLayer) {
        AppState.drawLayer.clearLayers();
    }
    AppState.linePoints = [];
    AppState.currentGeometry = null;
    hideGeometryStatus();
    
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    if (latInput) latInput.value = '';
    if (lngInput) lngInput.value = '';
    
    showToast('Drawing cleared', 'Click on map to start drawing again', 'info');
}

function useGPSPosition() {
    if (!AppState.currentPosition || AppState.geometryType !== 'Point') return;
    
    if (AppState.drawLayer) {
        AppState.drawLayer.clearLayers();
    }
    
    const markerIcon = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iNDEiIHZpZXdCb3g9IjAgMCAyNSA0MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi43IDAuNyAzLjlsMTEuOCAyNC42IDExLjgtMjQuNmMwLjQtMS4yIDAuNy0yLjYgMC43LTMuOUMyNSA1LjYgMTkuNCAwIDEyLjUgMHptMCAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjUtMiA0LjUtNC41IDQuNXoiIGZpbGw9IiMzMzg4ZmYiLz48L3N2Zz4=',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
    });
    
    L.marker([AppState.currentPosition.lat, AppState.currentPosition.lng], { icon: markerIcon }).addTo(AppState.drawLayer);
    
    AppState.currentGeometry = {
        type: 'Point',
        coordinates: [AppState.currentPosition.lng, AppState.currentPosition.lat],
    };
    
    document.getElementById('latitude').value = AppState.currentPosition.lat.toFixed(6);
    document.getElementById('longitude').value = AppState.currentPosition.lng.toFixed(6);
    
    AppState.map.setView([AppState.currentPosition.lat, AppState.currentPosition.lng], 16);
    
    showGeometryStatus();
    showToast('GPS position used!', 'Obstacle marked at your current location');
}

function updateManualCoordinates() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    
    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
        if (AppState.drawLayer) {
            AppState.drawLayer.clearLayers();
        }
        
        const markerIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iNDEiIHZpZXdCb3g9IjAgMCAyNSA0MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi43IDAuNyAzLjlsMTEuOCAyNC42IDExLjgtMjQuNmMwLjQtMS4yIDAuNy0yLjYgMC43LTMuOUMyNSA1LjYgMTkuNCAwIDEyLjUgMHptMCAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjUtMiA0LjUtNC41IDQuNXoiIGZpbGw9IiMzMzg4ZmYiLz48L3N2Zz4=',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
        });
        
        L.marker([lat, lng], { icon: markerIcon }).addTo(AppState.drawLayer);
        AppState.map.setView([lat, lng], 14);
        
        AppState.currentGeometry = {
            type: 'Point',
            coordinates: [lng, lat],
        };
        
        showGeometryStatus();
    }
}

function showGeometryStatus() {
    const statusEl = document.getElementById('geometry-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.style.display = 'flex';
    }
}

function hideGeometryStatus() {
    const statusEl = document.getElementById('geometry-status');
    if (statusEl) {
        statusEl.classList.add('hidden');
        statusEl.style.display = 'none';
    }
}

// ============================================================================
// OBSTACLE TYPE AUTOCOMPLETE
// ============================================================================

const obstacleTypes = ['Tower', 'Power Line', 'Wind Turbine', 'Building', 'Other'];

function showObstacleTypeDropdown() {
    const input = document.getElementById('obstacle-type-input');
    const dropdown = document.getElementById('obstacle-type-dropdown');
    if (dropdown) {
        filterObstacleTypes(input.value);
        dropdown.classList.remove('hidden');
    }
}

function hideObstacleTypeDropdown() {
    const dropdown = document.getElementById('obstacle-type-dropdown');
    if (dropdown) {
        dropdown.classList.add('hidden');
    }
}

function filterObstacleTypes(value) {
    const dropdown = document.getElementById('obstacle-type-dropdown');
    if (!dropdown) return;
    
    const filtered = obstacleTypes.filter(type => 
        type.toLowerCase().includes(value.toLowerCase())
    );
    
    if (filtered.length === 0 && value) {
        dropdown.innerHTML = `
            <div style="padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--muted-foreground);">
                No matching types found. Press Enter to use custom type.
            </div>
        `;
    } else {
        dropdown.innerHTML = filtered.map(type => `
            <button type="button" class="autocomplete-item" onclick="selectObstacleType('${type}')">
                ${getObstacleIcon(type)}
                <span>${type}</span>
            </button>
        `).join('');
    }
    
    dropdown.classList.remove('hidden');
}

function selectObstacleType(type) {
    document.getElementById('obstacle-type-input').value = type;
    hideObstacleTypeDropdown();
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const remember = document.getElementById('remember').checked;
    
    const user = mockLogin(username, password);
    
    if (user) {
        AppState.currentUser = user;
        
        if (remember) {
            localStorage.setItem('navisafe_remembered_username', username);
        } else {
            localStorage.removeItem('navisafe_remembered_username');
        }
        
        if (user.role === 'admin') {
            navigateTo('admin-dashboard');
        } else {
            navigateTo('pilot-report');
        }
    } else {
        const errorEl = document.getElementById('login-error');
        if (errorEl) {
            errorEl.textContent = 'Invalid username or password';
            errorEl.classList.remove('hidden');
        }
    }
}

function handleLogout() {
    AppState.currentUser = null;
    AppState.editingReport = null;
    stopGPSTracking();
    navigateTo('login');
}

function handleSubmitReport(event, isDraft = false) {
    if (event) event.preventDefault();
    
    if (!AppState.currentGeometry) {
        showToast('Please mark the obstacle position on the map', '', 'error');
        return;
    }
    
    const obstacleType = document.getElementById('obstacle-type-input').value;
    const heightFeet = document.getElementById('height').value;
    const description = document.getElementById('description').value;
    
    if (!isDraft && !heightFeet) {
        showToast('Please provide obstacle height', '', 'error');
        return;
    }
    
    const heightMeters = heightFeet ? parseFloat(heightFeet) * 0.3048 : undefined;
    
    const report = {
        id: AppState.editingReport?.id || `r${Date.now()}`,
        reporter_id: AppState.currentUser.id,
        reporter_name: AppState.currentUser.username,
        organization: AppState.currentUser.organization,
        obstacle_type: obstacleType,
        geometry_type: AppState.currentGeometry.type,
        geometry: AppState.currentGeometry,
        height_meters: heightMeters,
        description: description,
        comments: '',
        status: isDraft ? 'Draft' : 'Submitted',
        created_at: AppState.editingReport?.created_at || new Date().toISOString(),
        updated_at: new Date().toISOString(),
        reporter_position: AppState.currentPosition ? {
            type: 'Point',
            coordinates: [AppState.currentPosition.lng, AppState.currentPosition.lat]
        } : undefined,
        reporter_position_accuracy: AppState.currentPosition?.accuracy,
    };
    
    const index = AppState.reports.findIndex(r => r.id === report.id);
    if (index >= 0) {
        AppState.reports[index] = report;
    } else {
        AppState.reports.push(report);
    }
    
    if (isDraft) {
        showToast('Draft saved!', 'Your report has been saved as a draft.');
    } else {
        showToast('Report sent to NRL!', 'Your report has been submitted to Kartverket.');
    }
    
    AppState.editingReport = null;
    navigateTo('pilot-dashboard');
}

function updateHeightMeters(feet) {
    const heightMetersEl = document.getElementById('height-meters');
    if (heightMetersEl && feet) {
        const meters = Math.round(parseFloat(feet) * 0.3048);
        heightMetersEl.textContent = `≈ ${meters} meters`;
    } else if (heightMetersEl) {
        heightMetersEl.textContent = '';
    }
}

function handlePhotoUpload(event) {
    const file = event.target.files?.[0];
    if (file) {
        const label = document.getElementById('photo-label');
        if (label) {
            label.textContent = `✓ ${file.name}`;
        }
        showToast('Photo uploaded');
    }
}

function editReport(reportId) {
    const report = AppState.reports.find(r => r.id === reportId);
    if (report) {
        AppState.editingReport = report;
        navigateTo('pilot-report');
    }
}

function viewReport(reportId) {
    const report = AppState.reports.find(r => r.id === reportId);
    if (report) {
        alert(`Report #${report.id}\n\nType: ${report.obstacle_type}\nHeight: ${report.height_meters}m\nStatus: ${report.status}\nDescription: ${report.description}`);
    }
}

function viewAdminReport(reportId) {
    const report = AppState.reports.find(r => r.id === reportId);
    if (report) {
        showAdminReportModal(report);
    }
}

function showAdminReportModal(report) {
    const duplicates = findPotentialDuplicates(report, AppState.reports);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    };
    
    modal.innerHTML = `
        <div class="modal-content">
            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">Report Details #${report.id}</h2>
            <p style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 1.5rem;">
                Reported by ${report.reporter_name} (${report.organization}) on ${new Date(report.created_at).toLocaleDateString()}
            </p>
            
            ${duplicates.length > 0 ? `
                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="color: #d97706; flex-shrink: 0; margin-top: 0.125rem;">
                            ${Icons.alertTriangle}
                        </div>
                        <div>
                            <h3 style="font-weight: 600; color: #78350f; margin-bottom: 0.5rem;">Potential Duplicate Reports</h3>
                            <p style="font-size: 0.875rem; color: #92400e; margin-bottom: 0.75rem;">
                                Found ${duplicates.length} similar report${duplicates.length > 1 ? 's' : ''} within 100m with the same obstacle type.
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${duplicates.map(dup => `
                                    <div style="background: white; border-radius: 0.25rem; border: 1px solid #fcd34d; padding: 0.75rem;">
                                        <div><strong>Report #${dup.id}</strong> - ${dup.obstacle_type}</div>
                                        <div style="font-size: 0.875rem;">Distance: ${Math.round(dup.distance)}m</div>
                                        <div style="font-size: 0.875rem;">Height: ${dup.height_meters}m</div>
                                        <div style="font-size: 0.875rem;">Reporter: ${dup.reporter_name} (${dup.organization})</div>
                                        <div style="font-size: 0.875rem;">Status: ${dup.status}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Status</label>
                    <span class="badge ${
                        report.status === 'Approved' ? 'badge-green' :
                        report.status === 'Submitted' ? 'badge-blue' :
                        'badge-yellow'
                    }">
                        ${report.status}
                    </span>
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Obstacle Type</label>
                    <p>${report.obstacle_type}</p>
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Height</label>
                    <p>${report.height_meters ? `${report.height_meters} meters` : 'Not specified'}</p>
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Geometry</label>
                    <p>${report.geometry_type === 'Point' ? 'Point' : 'Line'}</p>
                </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                <p>${report.description}</p>
            </div>
            
            ${report.reporter_position ? `
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Reporter GPS Position</label>
                    <p style="font-size: 0.875rem; font-family: monospace;">
                        ${report.reporter_position.coordinates[1].toFixed(6)}°N, ${report.reporter_position.coordinates[0].toFixed(6)}°E
                        ${report.reporter_position_accuracy ? `(±${report.reporter_position_accuracy.toFixed(0)}m accuracy)` : ''}
                    </p>
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 1rem;">
                ${report.status === 'Submitted' ? `
                    <button onclick="approveReport('${report.id}')" class="btn btn-primary" style="flex: 1;">
                        ${Icons.checkCircle}
                        <span style="margin-left: 0.5rem;">Approve Report</span>
                    </button>
                ` : `
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: #059669;">
                        ${Icons.checkCircle}
                        <span>Already Approved</span>
                    </div>
                `}
                <button onclick="this.closest('.modal').remove()" class="btn btn-secondary" style="flex: 1;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function approveReport(reportId) {
    const index = AppState.reports.findIndex(r => r.id === reportId);
    if (index >= 0) {
        AppState.reports[index].status = 'Approved';
        AppState.reports[index].updated_at = new Date().toISOString();
        
        showToast('Report Approved', 'The report has been approved and registered in NRL.');
        
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
        
        navigateTo('admin-dashboard');
    }
}

function updateAdminView() {
    const sortBy = document.getElementById('admin-sort').value;
    const statusFilter = document.getElementById('admin-status').value;
    
    let reports = AppState.reports.filter(r => r.status !== 'Draft');
    
    if (statusFilter !== 'all') {
        reports = reports.filter(r => r.status === statusFilter);
    }
    
    reports.sort((a, b) => {
        switch (sortBy) {
            case 'date-newest':
                return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
            case 'date-oldest':
                return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();
            case 'duplicates-most':
                const dupCountA = findPotentialDuplicates(a, AppState.reports).length;
                const dupCountB = findPotentialDuplicates(b, AppState.reports).length;
                return dupCountB - dupCountA;
            default:
                return 0;
        }
    });
    
    const listEl = document.getElementById('reports-list');
    if (listEl) {
        listEl.innerHTML = renderAdminReportsTable(reports);
    }
}

// ============================================================================
// NAVIGATION
// ============================================================================

function navigateTo(view) {
    AppState.currentView = view;
    render();
    
    if (view === 'pilot-report') {
        startGPSTracking();
        setTimeout(() => {
            initMap();
            setInterval(updateGPSDisplay, 1000);
        }, 100);
    } else {
        stopGPSTracking();
    }
}

function render() {
    const app = document.getElementById('app');
    
    let html = '';
    
    switch (AppState.currentView) {
        case 'login':
            html = renderLoginScreen();
            break;
        case 'pilot-dashboard':
            html = renderPilotDashboard();
            break;
        case 'pilot-report':
            html = renderPilotReportForm();
            break;
        case 'admin-dashboard':
            html = renderAdminDashboard();
            break;
        default:
            html = renderLoginScreen();
    }
    
    app.innerHTML = html;
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    applyTheme();
    render();
});
</script>

</body>
</html>

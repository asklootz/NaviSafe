@model IEnumerable<NaviSafe.Data.ObstacleData>

@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - NaviSafe</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/admin-dashboard.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }
        
        .custom-marker div {
            animation: pulse 2s infinite;
        }
        
        @@keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .page-bg { background: #f8f9fa; }
    </style>
</head>

<body class="page-bg">
    <header>
        <nav class="navbar navbar-expand-sm navbar-light bg-white fixed-top shadow-sm">
            <div class="container-fluid">
                <img src="~/NaviSafeIcon.svg" alt="NaviSafe Logo" class="brand-logo me-2" />
                <div class="text-center">
                    <a class="navbar-brand fw-semibold" href="/">NaviSafe</a>
                    <br />
                    <span class="navbar-brand">Admin Dashboard</span>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <button class="btn btn-outline-primary btn-sm me-2" id="mapButton">
                                <i class="bi bi-map"></i> Show Map View
                            </button>
                        </li>
                        <li class="nav-item">
                            <form action="/Account/Logout" method="post" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container-fluid py-5 mt-5">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Submitted Reports</h6>
                        <h2>@Model.Count(r => r.IsSent)</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Pending Review</h6>
                        <h2 class="text-warning">@Model.Count(r => r.IsSent && r.State == "PENDING")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Approved</h6>
                        <h2 class="text-success">@Model.Count(r => r.IsSent && (r.State == "APPROVED" || r.State == "SENT"))</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Rejected</h6>
                        <h2 class="text-danger">@Model.Count(r => r.IsSent && r.State == "REJECTED")</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Submitted Obstacle Reports</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="reportsTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                                <th>Status</th>
                                <th>Image</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in Model.Where(r => r.IsSent))
                            {
                                <tr>
                                    <td>@report.regID</td>
                                    <td>@report.ShortDesc</td>
                                    <td>@(string.IsNullOrEmpty(report.LongDesc) ? "No description" : (report.LongDesc.Length > 50 ? report.LongDesc.Substring(0, 50) + "..." : report.LongDesc))</td>
                                    <td>@report.Lat.ToString("F6")</td>
                                    <td>@report.Lon.ToString("F6")</td>
                                    <td>
                                        <span class="badge @(report.State == "PENDING" ? "bg-warning" : (report.State == "APPROVED" || report.State == "SENT") ? "bg-success" : "bg-danger")">
                                            @report.State
                                        </span>
                                    </td>
                                    <td>
                                        @if (report.Img != null && report.Img.Length > 0)
                                        {
                                            <a href="@Url.Action("GetImage", "Obstacle", new { id = report.regID })" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="bi bi-image"></i> View
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No image</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary view-report" data-id="@report.regID">
                                            <i class="bi bi-eye"></i> View Details
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Map Modal -->
        <div class="modal fade" id="mapModal" tabindex="-1">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-map"></i> Obstacle Reports Map
                        </h5>
                        <div class="ms-auto me-3">
                            <div class="d-flex align-items-center">
                                <span class="me-3"><small>Legend:</small></span>
                                <span class="badge bg-warning me-2">Pending</span>
                                <span class="badge bg-success me-2">Approved</span>
                                <span class="badge bg-danger me-2">Rejected</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div id="mapContainer" style="height: 100vh;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Detail Modal -->
        <div class="modal fade" id="reportDetailModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-file-earmark-text"></i> Report Details & Review
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="reportDetails"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        $(document).ready(function () {
            // Get reports data with proper property names
            const reports = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Where(r => r.IsSent)));
            let mapInstance = null;
            let currentReportId = null;
            
            console.log('Reports data:', reports); // Debug log

            // View Report Details
            $('.view-report').on('click', function () {
                const reportId = $(this).data('id');
                currentReportId = reportId;
                const selectedReport = reports.find(r => r.regID === reportId);
                
                console.log('Selected report:', selectedReport); // Debug log
                
                if (selectedReport) {
                    showReportDetailsLoading();
                    fetchUserDetails(selectedReport.userID, function(userInfo) {
                        showReportDetailsFull(selectedReport, userInfo);
                    });
                }
            });

            function showReportDetailsLoading() {
                const loadingHtml = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Loading report details...</p></div>';
                $('#reportDetails').html(loadingHtml);
                $('#reportDetailModal').modal('show');
            }

            function fetchUserDetails(userId, callback) {
                $.ajax({
                    url: '/Home/GetUserDetails',
                    method: 'GET',
                    data: { userId: userId },
                    success: function(response) {
                        callback(response.userInfo);
                    },
                    error: function() {
                        const fallbackEmail = 'user' + userId + '@@navisafe.com';
                        callback({
                            UserID: userId,
                            FirstName: "Unknown",
                            LastName: "User",
                            Email: fallbackEmail,
                            Phone: "Not available",
                            OrganizationName: "Unknown Organization"
                        });
                    }
                });
            }

            function showReportDetailsFull(selectedReport, userInfo) {
                // Handle case sensitivity for JSON properties
                const reportId = selectedReport.regID || selectedReport.RegID;
                const shortDesc = selectedReport.shortDesc || selectedReport.ShortDesc;
                const longDesc = selectedReport.longDesc || selectedReport.LongDesc;
                const altitude = selectedReport.altitude || selectedReport.Altitude;
                const state = selectedReport.state || selectedReport.State;
                const lat = selectedReport.lat || selectedReport.Lat;
                const lon = selectedReport.lon || selectedReport.Lon;
                const img = selectedReport.img || selectedReport.Img;
                
                let html = '';
                html += '<div class="row">';
                html += '<div class="col-md-6">';
                
                // Report Info Card
                html += '<div class="card mb-3">';
                html += '<div class="card-header"><h6><i class="bi bi-info-circle"></i> Report Information</h6></div>';
                html += '<div class="card-body">';
                html += '<dl class="row">';
                html += '<dt class="col-sm-4">Report ID:</dt><dd class="col-sm-8">#' + reportId + '</dd>';
                html += '<dt class="col-sm-4">Type:</dt><dd class="col-sm-8">' + shortDesc + '</dd>';
                html += '<dt class="col-sm-4">Height:</dt><dd class="col-sm-8">' + (altitude || 'Not specified') + ' feet</dd>';
                html += '<dt class="col-sm-4">Status:</dt><dd class="col-sm-8"><span class="badge ' + getStatusBadgeClass(state) + '">' + state + '</span></dd>';
                
                if (lat && lon) {
                    html += '<dt class="col-sm-4">Coordinates:</dt><dd class="col-sm-8">' + parseFloat(lat).toFixed(6) + ', ' + parseFloat(lon).toFixed(6) + '</dd>';
                } else {
                    html += '<dt class="col-sm-4">Coordinates:</dt><dd class="col-sm-8">Not available</dd>';
                }
                
                html += '<dt class="col-sm-4">Description:</dt><dd class="col-sm-8">' + (longDesc || 'No description') + '</dd>';
                html += '</dl></div></div>';

                // Image Card
                if (img && img.length > 0) {
                    html += '<div class="card mb-3">';
                    html += '<div class="card-header"><h6><i class="bi bi-image"></i> Attached Image</h6></div>';
                    html += '<div class="card-body text-center">';
                    html += '<img src="/Obstacle/GetImage/' + reportId + '" class="img-fluid rounded" style="max-height: 300px; cursor: pointer;" onclick="window.open(\'/Obstacle/GetImage/' + reportId + '\', \'_blank\')" />';
                    html += '<br><small class="text-muted mt-2 d-block">Click to view full size</small>';
                    html += '</div></div>';
                } else {
                    html += '<div class="card mb-3">';
                    html += '<div class="card-header"><h6><i class="bi bi-image"></i> Image</h6></div>';
                    html += '<div class="card-body text-center text-muted py-4">';
                    html += '<i class="bi bi-camera-slash fs-1"></i>';
                    html += '<p class="mt-2">No image attached</p>';
                    html += '</div></div>';
                }

                // Reporter Card
                html += '<div class="card">';
                html += '<div class="card-header"><h6><i class="bi bi-person"></i> Reporter Information</h6></div>';
                html += '<div class="card-body">';
                html += '<dl class="row">';
                html += '<dt class="col-sm-4">Name:</dt><dd class="col-sm-8">' + userInfo.FirstName + ' ' + userInfo.LastName + '</dd>';
                html += '<dt class="col-sm-4">Email:</dt><dd class="col-sm-8"><a href="mailto:' + userInfo.Email + '">' + userInfo.Email + '</a></dd>';
                html += '<dt class="col-sm-4">Phone:</dt><dd class="col-sm-8">' + (userInfo.Phone !== 'Not available' ? '<a href="tel:' + userInfo.Phone + '">' + userInfo.Phone + '</a>' : userInfo.Phone) + '</dd>';
                html += '<dt class="col-sm-4">Organization:</dt><dd class="col-sm-8">' + userInfo.OrganizationName + '</dd>';
                html += '</dl></div></div>';

                html += '</div>'; // End left column

                // Right Column
                html += '<div class="col-md-6">';
                
                // Map Card
                if (lat && lon) {
                    html += '<div class="card mb-3">';
                    html += '<div class="card-header"><h6><i class="bi bi-geo-alt"></i> Location Map</h6></div>';
                    html += '<div class="card-body"><div id="detailMap" style="height: 350px;"></div></div>';
                    html += '</div>';
                } else {
                    html += '<div class="card mb-3">';
                    html += '<div class="card-header"><h6><i class="bi bi-geo-alt"></i> Location</h6></div>';
                    html += '<div class="card-body text-center text-muted py-4">';
                    html += '<i class="bi bi-geo-alt-slash fs-1"></i>';
                    html += '<p class="mt-2">No coordinates available</p>';
                    html += '</div></div>';
                }

                // Admin Controls Card
                html += '<div class="card">';
                html += '<div class="card-header"><h6><i class="bi bi-pencil-square"></i> Admin Review</h6></div>';
                html += '<div class="card-body">';
                html += '<div class="mb-3">';
                html += '<label for="adminReason" class="form-label"><strong>Reason for Decision:</strong> <span class="text-danger">*</span></label>';
                html += '<textarea class="form-control" id="adminReason" rows="3" placeholder="Enter reason for your decision..."></textarea>';
                html += '</div>';
                html += '<div class="mb-3">';
                html += '<label for="newStatus" class="form-label"><strong>Change Status:</strong></label>';
                html += '<select class="form-select" id="newStatus">';
                html += '<option value="">-- Select Status --</option>';
                html += '<option value="APPROVED"' + (state === 'APPROVED' ? ' selected' : '') + '>✅ Approved</option>';
                html += '<option value="SENT"' + (state === 'SENT' ? ' selected' : '') + '>📤 Sent/Published</option>';
                html += '<option value="REJECTED"' + (state === 'REJECTED' ? ' selected' : '') + '>❌ Rejected</option>';
                html += '<option value="PENDING"' + (state === 'PENDING' ? ' selected' : '') + '>⏳ Pending Review</option>';
                html += '</select></div>';
                html += '<button class="btn btn-primary w-100" id="updateStatusBtn"><i class="bi bi-save"></i> Update Status</button>';

                if (state === 'PENDING') {
                    html += '<hr>';
                    html += '<div class="row g-2">';
                    html += '<div class="col-6"><button class="btn btn-success w-100" id="quickApproveBtn">Quick Approve</button></div>';
                    html += '<div class="col-6"><button class="btn btn-danger w-100" id="quickRejectBtn">Quick Reject</button></div>';
                    html += '</div>';
                }

                html += '</div></div>'; // End admin card
                html += '</div>'; // End right column
                html += '</div>'; // End row

                $('#reportDetails').html(html);

                // Initialize map if coordinates are available
                if (lat && lon) {
                    setTimeout(() => {
                        const detailMap = L.map('detailMap').setView([parseFloat(lat), parseFloat(lon)], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
                        
                        const markerColor = getMarkerColor(state);
                        const customIcon = L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background-color: ' + markerColor + '; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [19, 19],
                            iconAnchor: [9, 9]
                        });
                        
                        L.marker([parseFloat(lat), parseFloat(lon)], { icon: customIcon })
                            .addTo(detailMap)
                            .bindPopup('<b>' + shortDesc + '</b>')
                            .openPopup();
                    }, 300);
                }
            }

            // Event handlers
            $(document).on('click', '#updateStatusBtn', function() {
                const newStatus = $('#newStatus').val();
                const reason = $('#adminReason').val();
                
                if (!newStatus || !reason.trim()) {
                    alert('Please select a status and provide a reason');
                    return;
                }
                
                updateReportStatus(currentReportId, newStatus, reason);
            });

            $(document).on('click', '#quickApproveBtn', function() {
                updateReportStatus(currentReportId, 'APPROVED', 'Quick approval - meets safety requirements');
            });

            $(document).on('click', '#quickRejectBtn', function() {
                const reason = prompt('Reason for rejection:');
                if (reason && reason.trim()) {
                    updateReportStatus(currentReportId, 'REJECTED', reason);
                }
            });

            // Show Map Modal
            $('#mapButton').on('click', function () {
                $('#mapModal').modal('show');
                
                setTimeout(() => {
                    if (!mapInstance) {
                        mapInstance = L.map('mapContainer').setView([65.0, 13.0], 6);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);

                        console.log('Adding markers for', reports.length, 'reports'); // Debug log

                        let validReports = [];
                        
                        reports.forEach(report => {
                            // Handle case sensitivity
                            const lat = report.lat || report.Lat;
                            const lon = report.lon || report.Lon;
                            const state = report.state || report.State;
                            const shortDesc = report.shortDesc || report.ShortDesc;
                            const longDesc = report.longDesc || report.LongDesc;
                            const reportId = report.regID || report.RegID;
                            const img = report.img || report.Img;
                            
                            console.log('Processing report:', reportId, 'with coordinates:', lat, lon); // Debug log
                            
                            if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
                                const markerColor = getMarkerColor(state);
                                const customIcon = L.divIcon({
                                    className: 'custom-marker',
                                    html: '<div style="background-color: ' + markerColor + '; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                });

                                const marker = L.marker([parseFloat(lat), parseFloat(lon)], { icon: customIcon }).addTo(mapInstance);
                                
                                let popup = '<div style="min-width: 200px;">';
                                popup += '<h6>' + shortDesc + '</h6>';
                                popup += '<p><small>' + (longDesc || 'No description') + '</small></p>';
                                popup += '<p><small><strong>Status:</strong> <span class="badge ' + getStatusBadgeClass(state) + '">' + state + '</span></small></p>';
                                if (img && img.length > 0) {
                                    popup += '<a href="/Obstacle/GetImage/' + reportId + '" target="_blank" class="btn btn-sm btn-outline-primary mb-2">View Image</a><br>';
                                }
                                popup += '<button class="btn btn-sm btn-primary" onclick="viewReportFromMap(' + reportId + ')">View Details</button>';
                                popup += '</div>';
                                
                                marker.bindPopup(popup);
                                validReports.push([parseFloat(lat), parseFloat(lon)]);
                                
                                console.log('Added marker at:', lat, lon); // Debug log
                            } else {
                                console.log('Skipping report with invalid coordinates:', reportId, lat, lon); // Debug log
                            }
                        });

                        // Fit map to show all markers if there are any valid reports
                        if (validReports.length > 0) {
                            const group = new L.featureGroup(validReports.map(coord => L.marker(coord)));
                            mapInstance.fitBounds(group.getBounds().pad(0.1));
                            console.log('Fitted bounds for', validReports.length, 'valid reports'); // Debug log
                        } else {
                            console.log('No valid reports with coordinates found'); // Debug log
                        }
                    }
                }, 300);
            });

            // Helper functions
            function getMarkerColor(state) {
                switch (state) {
                    case 'PENDING': return '#ffc107';
                    case 'APPROVED': return '#28a745';
                    case 'SENT': return '#28a745';
                    case 'REJECTED': return '#dc3545';
                    default: return '#6c757d';
                }
            }
            
            function getStatusBadgeClass(state) {
                switch (state) {
                    case 'PENDING': return 'bg-warning';
                    case 'APPROVED': return 'bg-success';
                    case 'SENT': return 'bg-success';
                    case 'REJECTED': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            function updateReportStatus(reportId, newStatus, reason) {
                $.ajax({
                    url: '/Home/UpdateReportStatus',
                    method: 'POST',
                    data: {
                        reportId: reportId,
                        newStatus: newStatus,
                        reason: reason,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('Status updated successfully!');
                            $('#reportDetailModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Error: ' + (response.message || 'Unknown error'));
                        }
                    },
                    error: function() {
                        alert('Failed to update status');
                    }
                });
            }

            window.viewReportFromMap = function(reportId) {
                $('#mapModal').modal('hide');
                setTimeout(() => {
                    $('.view-report[data-id="' + reportId + '"]').click();
                }, 500);
            };
        });
    </script>
</body>
</html>
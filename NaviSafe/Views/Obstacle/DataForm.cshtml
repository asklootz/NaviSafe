@model NaviSafe.Models.ObstacleData

@{
    ViewData["Title"] = "Registration Form";
    Layout = null;
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/obstacle-form.css" />
</head>
<body class="page-bg">
<header>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-transparent container-fluid">
            <div class="container-fluid">
                <img src="~/NaviSafeIcon.svg" alt="NaviSafe Logo" class="brand-logo me-2"/>
                <div class="text-center"><a class="navbar-brand fw-semibold " asp-area="" asp-controller="Home" asp-action="Index">NaviSafe</a><br/><a class="navbar-brand">New Registration</a></div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    
                </div>
                <button class="btn btn-report "><img src="~/list-icon.svg" alt="List Icon" class=""/> My Registrations</button>
            </div>
        </nav>
    </header>
</header>

<section class="container-fluid my-4">
    <div class="row justify-content-center">
        <div class="col-12 ">
            <div class="card card-ns shadow-sm">
                <div class="card-body p-4">
                    <header class="mb-3">
                        <h1 class="fs-3 fw-semibold mb-1 text-center" >Obstacle Registration Form</h1>
                        <p class="text-secondary mb-0 text-center">Fields with * must be filled</p>
                    </header>

                    <form asp-action="DataForm" method="post" class="">
                        <div class="row g-4">
                            <div class="col-12">
                                <label asp-for="ObstacleName" class="form-label formLabel">Obst acle Type* :</label>
                                <div class="position-relative">
                                    <input asp-for="ObstacleName"
                                           id="ObstacleName"
                                           class="form-control formTextField"
                                           autocomplete="off"
                                           placeholder="e.g., Tower, Tree" />
                                    <div id="ObstacleNameMenu" class="dropdown-menu w-100 shadow-sm border-black" style="max-height:600px;"></div>
                                </div>
                                <span asp-validation-for="ObstacleName" class="text-danger small"></span>
                            </div>
                            
                            <div class="mt-4">
                                <label asp-for="ObstacleDescription" class="form-label formLabel">Full Description:</label>
                                <textarea asp-for="ObstacleDescription" rows="4" class="form-control formTextField"  placeholder="Describe the obstacle, materials, location, etc."></textarea>
                                <span asp-validation-for="ObstacleDescription" class="text-danger small"></span>
                            </div>
                            
                            
                            
                            
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <label class="form-label mb-0 formLabel">Provide coordinates* :</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" id="liveOption" name="dataSource" value="live" checked>
                                        <label class="form-check-label" for="liveOption">Live data</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" id="markerOption" name="dataSource" value="marker">
                                        <label class="form-check-label" for="markerOption">Marker data</label>
                                    </div>
                                </div>
                            </div>

                            <div id="map" class="map-container col-12"></div>
                            <input type="hidden" asp-for="GeometryGeoJson" id="GeometryGeoJson"/>

                            <div class="mt-3">
                                <label for="MarkerCoordinatesJSON" class="form-label">Coordinates Preview</label>
                                <textarea id="MarkerCoordinatesJSON" class="form-control form-control-sm" rows="3" readonly placeholder="Draw on the map to see coordinates here..."></textarea>
                                <label for="LiveCoordinates" class="form-label mt-2">Live coordinates</label>
                                <textarea id="LiveCoordinates" class="form-control form-control-sm" rows="4" readonly placeholder="Your live coordinates will appear here..."></textarea>

                                <!-- New separate latitude/longitude inputs -->
                                <div class="row mt-2 g-2">
                                    <div class="col-6">
                                        <label for="Latitude" class="form-label formLabel">Latitude</label>
                                        <input type="text" id="Latitude" class="form-control formTextField" placeholder="Latitude" />
                                    </div>
                                    <div class="col-6">
                                        <label for="Longitude" class="form-label formLabel">Longitude</label>
                                        <input type="text" id="Longitude" class="form-control formTextField" placeholder="Longitude" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <label asp-for="ObstacleHeight" class="form-label formLabel">Obstacle Height (feet):</label>
                                <input asp-for="ObstacleHeight" type="number" step="0.01" min="0" class="form-control formTextField" placeholder="e.g., 2.5" />
                                <span asp-validation-for="ObstacleHeight" class="text-danger small"></span>
                            </div>
                            
                            
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="btn btn-indigo">
                                Submit Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
</body>

    <partial name="_ValidationScriptsPartial"/>

    <link rel="stylesheet" href="~/lib/leaflet/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <script src="~/lib/leaflet/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <link rel="stylesheet" href="~/lib/leaflet-locatecontrol-0.85.0/leaflet-locatecontrol-0.85.0/dist/L.Control.Locate.mapbox.min.css"/>
    <script src="~/lib/leaflet-locatecontrol-0.85.0/leaflet-locatecontrol-0.85.0/dist/L.Control.Locate.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

    <script>
        let map = L.map('map').setView([58.163137,8.002106], 13);

        let osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        osm.addTo(map);

        let lc = L.control
            .locate({
                position: 'topleft', flyTo: true, setView: 'always', cacheLocation: true,
                locateOptions: {
                    maxZoom: 16,
                    enableHighAccuracy: true,
                    watch: true
                }
            }).addTo(map);

        lc.getContainer().id = "locate-button";
        lc.start();

        // State flags
        let useLiveData = true;
        let markerPlaced = false;
        let manualOverride = false;

        // Helper to update geometry and previews from a lat/lng pair
        function updateFromLatLng(lat, lng, accuracy = null, source = 'manual') {
            if (lat == null || lng == null || Number.isNaN(lat) || Number.isNaN(lng)) return;

            const coords = [lng, lat];
            const feature = {
                type: 'Feature',
                geometry: { type: 'Point', coordinates: coords },
                properties: { source: source }
            };

            const json = JSON.stringify(feature);
            document.getElementById('GeometryGeoJson').value = json;
            document.getElementById('MarkerCoordinatesJSON').value = json;

            // Update lat/lng inputs (format to 6 decimals)
            document.getElementById('Latitude').value = lat.toFixed ? lat.toFixed(6) : lat;
            document.getElementById('Longitude').value = lng.toFixed ? lng.toFixed(6) : lng;

            // place a marker in drawnItems for visual feedback
            drawnItems.clearLayers();
            const m = L.marker([lat, lng]);
            drawnItems.addLayer(m);
        }

        map.on('locationfound', function(e) {
            // only update if using live data and no marker placed and user didn't manually override
            if (!useLiveData || markerPlaced || manualOverride) return;

            drawnItems.clearLayers();
            let lat = e.latlng.lat;
            let lng = e.latlng.lng;
            let radius = e.accuracy;
            let altitude = e.latlng.alt;

            let LiveCoordinatesJSON = {
                "type": "Feature",
                "geometry": { "type": "Point", "coordinates": [lng, lat] },
                "properties": { "accuracy": radius, "altitude": altitude }
            };
            let liveCoordinatesJSONString = JSON.stringify(LiveCoordinatesJSON);
            let liveCoordinates = "Lat: " + lat + "\nLng: " + lng + "\nAccuracy: " + radius + "m" + "\nJSON: " + liveCoordinatesJSONString;
            document.getElementById("LiveCoordinates").value = liveCoordinates;

            // update the lat/lng fields and geometry
            updateFromLatLng(lat, lng, radius, 'live');
        });

        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        let drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                polyline: false,
                marker: true,
                circle: false,
                circlemarker: false,
                rectangle: false
            },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        var customMarkerControl = L.Control.extend({
            options: {
                position: 'topleft' // Position of the control on the map
            },

            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.innerHTML = '<button title="Draw Custom Marker" class="custom-marker-button"></button>';

                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.on(container, 'click', function() {
                    map.once('click', function(e) {
                        L.marker(e.latlng, {
                            icon: L.icon({
                                iconUrl: '~/NaviSafeIcon.png',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32]
                            })
                        }).addTo(map);
                    });
                });

                return container;
            }
        });

        map.addControl(new customMarkerControl());

        map.on(L.Draw.Event.CREATED, function (e) {
            // When a marker is drawn, stop live tracking and use marker coordinates
            drawnItems.clearLayers();
            let layer = e.layer;
            lc.stop();
            useLiveData = false;
            markerPlaced = true;
            manualOverride = false; // marker is explicit placement

            drawnItems.addLayer(layer);
            let geoJsonData = layer.toGeoJSON();
            let geoJsonString = JSON.stringify(geoJsonData);

            document.getElementById('GeometryGeoJson').value = geoJsonString;
            document.getElementById('MarkerCoordinatesJSON').value = geoJsonString;

            // update lat/lng inputs
            if (layer.getLatLng) {
                const latlng = layer.getLatLng();
                document.getElementById('Latitude').value = latlng.lat.toFixed(6);
                document.getElementById('Longitude').value = latlng.lng.toFixed(6);
            }
        });

        // Radio handling
        document.getElementById('liveOption').addEventListener('change', function () {
            useLiveData = true;
            manualOverride = false;
            markerPlaced = false;
            lc.start();
            drawnItems.clearLayers();
            document.getElementById('GeometryGeoJson').value = "";
            document.getElementById('MarkerCoordinatesJSON').value = "";
        });

        document.getElementById('markerOption').addEventListener('change', function () {
            useLiveData = false;
            lc.stop();
            // allow user to draw a marker or type coordinates
        });

        // Coordinate inputs: if user edits them manually we stop live tracking and use those coords
        const latInput = document.getElementById('Latitude');
        const lngInput = document.getElementById('Longitude');

        function onManualCoordinateChange() {
            const latVal = parseFloat(latInput.value);
            const lngVal = parseFloat(lngInput.value);

            if (isFinite(latVal) && isFinite(lngVal)) {
                manualOverride = true;
                useLiveData = false;
                markerPlaced = false;
                lc.stop();
                // place marker and update geometry
                updateFromLatLng(latVal, lngVal, null, 'manual');
                // pan map to coordinates
                try { map.setView([latVal, lngVal], Math.max(map.getZoom(), 13)); } catch { }
            }
        }

        latInput.addEventListener('change', onManualCoordinateChange);
        lngInput.addEventListener('change', onManualCoordinateChange);

    </script>
    
    <script>
        // Suggestions source (add more as needed, icons will need to be added too)
const obstacleSuggestions = [
  'Tree','Building','Pole','Tower','Crane', 'PowerLine'
];

const obstacleIcons = {
    'Tree' : '~/tree-icon.svg',
    'Building' : '~/building-icon.svg',
    'Pole' : '~/pole-icon.svg',
    'Tower' : '~/tower-icon.svg',
    'Crane' : '~/crane-icon.svg',
    'PowerLine' : '~/powerline-icon.svg'
}

const input = document.getElementById('ObstacleName');

const menu = document.getElementById('ObstacleNameMenu');

let activeIndex = -1;

function openMenu() { menu.classList.add('show'); }
        
function closeMenu() { menu.classList.remove('show'); activeIndex = -1; }
        
function renderMenu(items) {
  menu.innerHTML = '';
  if (!items.length) { closeMenu(); return; }
  items.forEach((text) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dropdown-item';
    btn.textContent = text;
    btn.addEventListener('mousedown', (e) => { e.preventDefault(); select(text); });
    menu.appendChild(btn);
  });
  openMenu();
}

function select(text) {
  input.value = text;
  closeMenu();
}

function currentItems() {
  return Array.from(menu.querySelectorAll('.dropdown-item, .dropdownoptions'));
}

function setActive(i) {
  const items = currentItems();
  items.forEach((el, idx) => el.classList.toggle('active', idx === i));
  const active = items[i];
  if (active) active.scrollIntoView({ block: 'nearest' });
}

input.addEventListener('input', () => {
  const q = input.value.trim().toLowerCase();
  if (!q) { closeMenu(); return; }
  const matches = obstacleSuggestions
    .filter(s => s.toLowerCase().includes(q))
    .slice(0, 8);
  renderMenu(matches);
});


input.addEventListener('keydown', (e) => {
  if (!menu.classList.contains('show')) return;
  const items = currentItems();
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    activeIndex = (activeIndex + 1) % items.length;
    setActive(activeIndex);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    activeIndex = (activeIndex - 1 + items.length) % items.length;
    setActive(activeIndex);
  } else if (e.key === 'Enter') {
    if (activeIndex >= 0) {
      e.preventDefault();
      items[activeIndex].dispatchEvent(new Event('mousedown'));
    }
  } else if (e.key === 'Escape') {
    closeMenu();
  }
});

input.addEventListener('blur', () => setTimeout(closeMenu, 150));
document.addEventListener('click', (e) => {
  if (!menu.contains(e.target) && e.target !== input) closeMenu();
});

if (input.value === 'Tree') {
    input.value = 'Tree';
}
</script>

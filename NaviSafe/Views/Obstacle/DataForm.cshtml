@model NaviSafe.Models.ObstacleDataForm

@{
    ViewData["Title"] = "Registration Form";
    Layout = null;
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/obstacle-form.css" />
</head>
<body class="page-bg">
<header>
    <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-transparent container-fluid">
        <div class="container-fluid">
            <img src="~/NaviSafeIcon.svg" alt="NaviSafe Logo" class="brand-logo me-2"/>
            <div class="text-center"><a class="navbar-brand fw-semibold " asp-area="" asp-controller="Home" asp-action="Index">NaviSafe</a><br/><a class="navbar-brand">New Registration</a></div>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                </div>
            <div class="align-content-md-center">
                <h1 class="fs-3 fw-semibold mb-1 text-center">Obstacle Registration Form</h1>
                <p class="text-decoration-underline mb-0 text-center">Fields with <span class="text-danger">*</span> must be filled</p>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    
            </div>
            <button class="btn btn-report fs-3" type="button"><i class="bi bi-list fs-2 me-3"></i>My Registrations</button>
        </div>
    </nav>
</header>

<section class="container-fluid my-4">
    <div class="row justify-content-center">
        <div class="col-12 ">
            <div class="card card-ns shadow-sm">
                <div class="card-body p-4">
                    @* <header class="mb-3">
                        <h1 class="fs-3 fw-semibold mb-1 text-center" >Obstacle Registration Form</h1>
                        <p class="text-decoration-underline mb-0 text-center">Fields with <span class="text-danger">*</span> must be filled</p>
                    </header> *@

                    <form asp-action="DataForm" method="post" class="" >@Html.AntiForgeryToken()
                        <div class="row g-4">
                            <div class="col-12">
                                <label asp-for="shortDesc" class="form-label formLabel">
                                    <i class="bi bi-tag-fill"></i>
                                    <span>Obstacle Type <span class="text-danger">*</span></span>
                                </label>
                                <div class="position-relative">
                                    <input asp-for="shortDesc"
                                           id="ObstacleName"
                                           class="form-control formTextField"
                                           autocomplete="off"
                                           placeholder="e.g., Tower, Tree, etc..." />
                                    @* <div id="ObstacleNameMenu" class="dropdown-menu w-100 shadow-sm border-black" style="max-height:600px;"></div> *@
                                

                  
                                <!-- Custom Autocomplete Dropdown -->
                                <div id="ObstacleNameDropdown" class="autocomplete-dropdown" style="display: none;">
                                    <div class="autocomplete-item" data-value="Building">
                                        <i class="bi bi-building-fill fs-2 me-3"></i>
                                        <span class="fs-5 fw-bold">Building</span>
                                    </div>
                                    <div class="autocomplete-item" data-value="Tree">
                                        <i class="bi bi-tree-fill text-success fs-2 me-3"></i>
                                        <span class="fs-5 fw-bold">Tree</span>
                                    </div>
                                    <div class="autocomplete-item" data-value="Tower">
                                        <i class="bi bi-broadcast-pin text-danger fs-2 me-3"></i>
                                        <span class="fs-5 fw-bold">Tower</span>
                                    </div>
                                    <div class="autocomplete-item" data-value="Power Line">
                                        <i class="bi bi-lightning-charge-fill text-warning fs-2 me-3"></i>
                                        <span class="fs-5 fw-bold">Power Line</span>
                                    </div>
                                    <div class="autocomplete-item" data-value="Wind Turbine">
                                        <i class="bi bi-fan fs-2 me-3"></i>
                                        <span class="fs-5 fw-bold">Wind Turbine</span>
                                    </div>
                                    <div class="autocomplete-item" data-value="Other">
                                        <i class="bi bi-three-dots text-muted fs-2 me-3"></i>
                                        <span class="fs-5 fw-bold">Other</span>
                                    </div>
                                    </div>
                                </div>
                            </div>
                                <span asp-validation-for="shortDesc" class="text-danger small"></span>
                            
                            <div class="mt-4">
                                <label asp-for="longDesc" class="form-label formLabel">
                                    <i class="bi bi-info-lg"></i>
                                    <span>Obstacle Type</span>
                                   </label>
                                <textarea asp-for="longDesc" rows="4" class="form-control formTextField"  placeholder="Describe the obstacle, materials, location, etc."></textarea>
                                @* <span asp-validation-for="longDesc" class="text-danger small"></span> *@
                            </div>
                            
                            
                            
                            
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                    <label class="form-label mb-0 formLabel">
                                        <i class="bi bi-geo-fill"></i>
                                        <span>Provide Coordinates <span class="text-danger">*</span></span>
                                    </label>
                             </div>

                            <div id="map" class="map-container col-12"></div>
                            <input type="hidden" asp-for="GeometryGeoJson" id="GeometryGeoJson"/>

                            <div class="mt-3">

                                <!-- New separate latitude/longitude inputs -->
                                <div class="row mt-2 g-2">
                                    <div class="col-6">
                                            <label asp-for="lat" class="form-label formLabel">Latitude <span class="text-danger">*</span></label>
                                        <input asp-for="lat" type="number" inputmode="decimal" step="0.000001" id="Latitude" class="form-control formTextField" placeholder="Latitude" />
                                    </div>
                                    <div class="col-6">
                                            <label asp-for="lon" class="form-label formLabel">Longitude <span class="text-danger">*</span></label>
                                        <input asp-for="lon" type="number" inputmode="decimal" step="0.000001" id="Longitude" class="form-control formTextField" placeholder="Longitude" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <label asp-for="altitude" class="form-label formLabel">Obstacle Height (feet):</label>
                                <div class="row g-2 align-items-center">
                                    <div class="col-6">
                                        <input asp-for="altitude" type="number" step="0.01" min="0" class="form-control formTextField" placeholder="e.g., 2.5" />
                                        @* <span asp-validation-for="ObstacleHeight" class="text-danger small"></span> *@
                                    </div>
                                    <div class="col-3 text-center">
                                        <button type="button" class="btn btn-primary btn-img w-100" id="openCameraButton">
                                            <i class="bi bi-camera-fill"></i> Camera
                                        </button>
                                        <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display: none;" />
                                    </div>
                                    <div class="col-3 text-center">
                                        <button type="button" class="btn btn-secondary btn-img w-100" id="uploadImageButton">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                        <input type="file" id="uploadImageInput" accept="image/*" style="display: none;" />
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12 text-center">
                                        <img id="imagePreview" src="#" alt="Image Preview" style="display: none; max-width: 100%; max-height: 300px; border: 1px solid #ccc; border-radius: 10px;" />
                                    </div>
                                </div>
                            </div>

                        <script>
                            document.getElementById('uploadImageButton').addEventListener('click', function () {
                                document.getElementById('uploadImageInput').click();
                            });

                            document.getElementById('openCameraButton').addEventListener('click', function () {
                                document.getElementById('cameraInput').click();
                            });

                            function displayImagePreview(file) {
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    const preview = document.getElementById('imagePreview');
                                    preview.src = e.target.result;
                                    preview.style.display = 'block';
                                };
                                reader.readAsDataURL(file);
                            }

                            document.getElementById('uploadImageInput').addEventListener('change', function (event) {
                                const file = event.target.files[0];
                                if (file) {
                                    console.log('Image uploaded:', file.name);
                                    displayImagePreview(file);
                                }
                            });

                            document.getElementById('cameraInput').addEventListener('change', function (event) {
                                const file = event.target.files[0];
                                if (file) {
                                    console.log('Picture taken:', file.name);
                                    displayImagePreview(file);
                                }
                            });
                        </script>
                        </div>
                        <div class="mt-4">
                            <div class="row mt-3 g-2">
                                <div class="col-6">
                                    <button type="submit" class="btn btn-yellow w-100"> <i class="bi bi-pencil-square"></i> Save as Draft</button>
                                </div>
                                <div class="col-6">
                                    <button type="submit" class="btn btn-green w-100"> <i class="bi bi-check-circle-fill"></i> Submit Data</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
</body>

    <partial name="_ValidationScriptsPartial"/>

    <link rel="stylesheet" href="~/lib/leaflet/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <script src="~/lib/leaflet/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <link rel="stylesheet" href="~/lib/leaflet-locatecontrol-0.85.0/leaflet-locatecontrol-0.85.0/dist/L.Control.Locate.mapbox.min.css"/>
    <script src="~/lib/leaflet-locatecontrol-0.85.0/leaflet-locatecontrol-0.85.0/dist/L.Control.Locate.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/dist/jquery.validate.unobtrusive.min.js"></script>

    <script>
        let map = L.map('map').setView([58.163137,8.002106], 13);

        let osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        osm.addTo(map);

        let lc = L.control
            .locate({
                position: 'topleft', flyTo: true, setView: 'always', cacheLocation: true,
                locateOptions: {
                    maxZoom: 16,
                    enableHighAccuracy: true,
                    watch: true
                }
            }).addTo(map);

        lc.getContainer().id = "locate-button";
        lc.start();

        // When user activates the locate control, resume live updates and clear marker/manual overrides
        (function() {
            const locateBtn = document.getElementById('locate-button');
            if (!locateBtn) return;
            locateBtn.addEventListener('click', function () {
                // allow live location to be used again
                markerPlaced = false;
                manualOverride = false;
                try { drawnItems.clearLayers(); } catch (ex) { }

                // ensure locate/watch is running
                try {
                    lc.start();
                    map.locate({ watch: true, setView: false, enableHighAccuracy: true });
                } catch (ex) { console.warn('Failed to restart locate', ex); }
            });
        })();

        // Also start the browser geolocation explicitly to ensure 'locationfound' events fire
        try {
            map.locate({ watch: true, setView: false, enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 });
        } catch (ex) {
            console.warn('map.locate failed', ex);
        }

        // show geolocation errors in console and notify user if needed
        map.on('locationerror', function(ev) {
            console.warn('locationerror', ev);
        });

        // State flags
        let markerPlaced = false;
        let manualOverride = false;

        // Helper to update geometry and previews from a lat/lng pair
        function updateFromLatLng(lat, lng, accuracy = null, source = 'manual') {
            if (lat == null || lng == null || Number.isNaN(lat) || Number.isNaN(lng)) return;

            const coords = [lng, lat];
            const feature = {
                type: 'Feature',
                geometry: { type: 'Point', coordinates: coords },
                properties: { source: source }
            };

            const json = JSON.stringify(feature);

            const geoEl = document.getElementById('GeometryGeoJson');
            if (geoEl) geoEl.value = json;
            const previewEl = document.getElementById('MarkerCoordinatesJSON');
            if (previewEl) previewEl.value = json;

            // Update lat/lng inputs (format to 6 decimals)
            const latEl = document.getElementById('Latitude');
            const lngEl = document.getElementById('Longitude');
            if (latEl) latEl.value = (typeof lat === 'number' && isFinite(lat)) ? lat.toFixed(6) : String(lat);
            if (lngEl) lngEl.value = (typeof lng === 'number' && isFinite(lng)) ? lng.toFixed(6) : String(lng);
        }

        map.on('locationfound', function(e) {
            // only update if no marker placed and user didn't manually override
            if (markerPlaced || manualOverride) return;

            drawnItems.clearLayers();
            let lat = e.latlng.lat;
            let lng = e.latlng.lng;
            let radius = e.accuracy;
            let altitude = e.latlng.alt;

            let LiveCoordinatesJSON = {
                "type": "Feature",
                "geometry": { "type": "Point", "coordinates": [lng, lat] },
                "properties": { "accuracy": radius, "altitude": altitude }
            };
            let liveCoordinatesJSONString = JSON.stringify(LiveCoordinatesJSON);
            let liveCoordinates = "Lat: " + lat + "\nLng: " + lng + "\nAccuracy: " + radius + "m" + "\nJSON: " + liveCoordinatesJSONString;
            const liveEl = document.getElementById("LiveCoordinates");
            if (liveEl) liveEl.value = liveCoordinates;

            // update the lat/lng fields and geometry
            updateFromLatLng(lat, lng, radius, 'live');
        });

        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        let drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                polyline: false,
                marker: true,
                circle: false,
                circlemarker: false,
                rectangle: false
            },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        


        map.on(L.Draw.Event.CREATED, function (e) {
            // When a marker is drawn, stop live tracking and use marker coordinates
            drawnItems.clearLayers();
            let layer = e.layer;
            lc.stop();
            markerPlaced = true;
            manualOverride = false; // marker is explicit placement

            drawnItems.addLayer(layer);
            let geoJsonData = layer.toGeoJSON();
            let geoJsonString = JSON.stringify(geoJsonData);

            // Set the hidden geojson (use layer's geojson for accuracy)
            var geoEl = document.getElementById('GeometryGeoJson');
            var previewEl = document.getElementById('MarkerCoordinatesJSON');
            if (geoEl) geoEl.value = geoJsonString;
            if (previewEl) previewEl.value = geoJsonString;

            // update lat/lng inputs using central helper so marker visuals and inputs stay in sync
            if (typeof layer.getLatLng === 'function') {
                const latlng = layer.getLatLng();
                updateFromLatLng(latlng.lat, latlng.lng, null, 'marker');

                // explicitly set Latitude/Longitude inputs as well
                var latInputEl = document.getElementById('Latitude');
                var lngInputEl = document.getElementById('Longitude');
                if (latInputEl) latInputEl.value = (latlng.lat).toFixed(6);
                if (lngInputEl) lngInputEl.value = (latlng.lng).toFixed(6);
            }
        });

        // Coordinate inputs: if user edits them manually we stop live tracking and use those coords
        const latInput = document.getElementById('Latitude');
        const lngInput = document.getElementById('Longitude');

        function onManualCoordinateChange() {
            const latVal = parseFloat(latInput.value);
            const lngVal = parseFloat(lngInput.value);

            if (isFinite(latVal) && isFinite(lngVal)) {
                manualOverride = true;
                markerPlaced = false;
                lc.stop();
                // place marker and update geometry
                updateFromLatLng(latVal, lngVal, null, 'manual');
                // pan map to coordinates
                try { map.setView([latVal, lngVal], Math.max(map.getZoom(), 13)); } catch { }
            }
        }

        latInput.addEventListener('change', onManualCoordinateChange);
        lngInput.addEventListener('change', onManualCoordinateChange);

    </script>
    
<script>
function setupObstacleNameAutocomplete() {
    const $input = $('#ObstacleName');
    const $dropdown = $('#ObstacleNameDropdown');
    const $items = $('.autocomplete-item');

    // Show dropdown on focus
    $input.on('focus', function() {
    $dropdown.show().addClass('show');
    filterAutocompleteItems(''); // Show all items
    });

    // Filter items as user types
    $input.on('input', function() {
    const searchText = $(this).val().toLowerCase();
    filterAutocompleteItems(searchText);
    });

    // Hide dropdown when clicking outside
    $(document).on('click', function(e) {
    if (!$(e.target).closest('#ObstacleName, #ObstacleNameDropdown').length) {
        $dropdown.hide().removeClass('show');
    }
    });

    // Select item on click
    $items.on('click', function() {
    const value = $(this).data('value');
    $input.val(value);
    $dropdown.hide().removeClass('show');

    // Visual feedback
    $input.addClass('border-success');
    setTimeout(function() {
        $input.removeClass('border-success');
    }, 1000);

    // Focus next field (height)
    $('#obstacleHeight').focus();
    });

    // Handle keyboard navigation
    let highlightedIndex = -1;

    $input.on('keydown', function(e) {
    const $visibleItems = $items.filter(':visible');

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        highlightedIndex = Math.min(highlightedIndex + 1, $visibleItems.length - 1);
        updateHighlight($visibleItems);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        highlightedIndex = Math.max(highlightedIndex - 1, 0);
        updateHighlight($visibleItems);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (highlightedIndex >= 0 && highlightedIndex < $visibleItems.length) {
        $visibleItems.eq(highlightedIndex).click();
        }
    } else if (e.key === 'Escape') {
        $dropdown.hide().removeClass('show');
    }
    });

    function filterAutocompleteItems(searchText) {
    let visibleCount = 0;

    $items.each(function() {
        const itemText = $(this).data('value').toLowerCase();

        if (itemText.includes(searchText)) {
        $(this).show();
        visibleCount++;
        } else {
        $(this).hide();
        }
    });

    // Show dropdown if there are visible items
    if (visibleCount > 0 && $input.is(':focus')) {
        $dropdown.show().addClass('show');
    } else if (visibleCount === 0) {
        $dropdown.hide().removeClass('show');
    }

    // Reset highlight
    highlightedIndex = -1;
    $items.removeClass('highlighted');
    }

    function updateHighlight($visibleItems) {
    $items.removeClass('highlighted');
    if (highlightedIndex >= 0 && highlightedIndex < $visibleItems.length) {
        $visibleItems.eq(highlightedIndex).addClass('highlighted');

        // Scroll highlighted item into view
        const $highlighted = $visibleItems.eq(highlightedIndex);
        const dropdownScrollTop = $dropdown.scrollTop();
        const dropdownHeight = $dropdown.height();
        const itemTop = $highlighted.position().top;
        const itemHeight = $highlighted.outerHeight();

        if (itemTop < 0) {
        $dropdown.scrollTop(dropdownScrollTop + itemTop);
        } else if (itemTop + itemHeight > dropdownHeight) {
        $dropdown.scrollTop(dropdownScrollTop + itemTop + itemHeight - dropdownHeight);
        }
    }
    }
}

    setupObstacleNameAutocomplete();
</script>
